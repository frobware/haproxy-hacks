#!/usr/bin/bash

set -eu
set -o pipefail

: ${DATAFILE:=results/${N:-1000}/joblog.dat}

echo "Analyzing ${DATAFILE}"

echo "List of curl requests that exceeded the timeout:"
sqlite3 <<EOF | awk '{ print "  ", $0 }'
.separator "\t"
.import $DATAFILE results
.headers on
select Seq,Starttime,JobRuntime,Receive,Exitval from results where Exitval != 0 and Receive == 0;
EOF

echo
echo "List of curl requests that didn't complete:"
sqlite3 <<EOF | awk '{ print "  ", $0 }'
.separator "\t"
.import $DATAFILE results
.headers on
select Seq,Starttime,JobRuntime,Receive,Exitval from results where Exitval != 0 and Receive != 0;
EOF

echo
echo "curl failures:"
sqlite3 <<EOF | awk '{ print "  ", $0 }'
.separator "\t"
.import curl-error-codes.txt exitcodes
.import $DATAFILE results
.headers on
select Seq,Starttime,JobRuntime,Receive,Exitval,message from results inner join exitcodes on results.Exitval = exitcodes.code;
EOF

echo
echo "count(curl requests that exceeded the timeout):"
sqlite3 <<EOF
.separator "\t"
.import $DATAFILE results
select count(*) from results where Exitval != 0 and Receive == 0;
EOF

echo
echo "count(curl requests that didn't complete):"
sqlite3 <<EOF
.separator "\t"
.import $DATAFILE results
select count(*) from results where Exitval != 0 and Receive != 0;
EOF

echo
echo "count(failed requests): "
sqlite3 <<EOF
.separator "\t"
.import $DATAFILE results
select count(*) from results where Exitval != 0;
EOF

echo
echo "count(successful requests): "
sqlite3 <<EOF
.separator "\t"
.import $DATAFILE results
select count(*) from results where Exitval == 0;
EOF

echo
echo "execution time (seconds) for successful requests: "
sqlite3 <<EOF
.separator "\t"
.import $DATAFILE results
.headers on
select min(JobRuntime),max(JobRuntime),round(avg(JobRuntime),3) from results where Exitval == 0;
EOF
