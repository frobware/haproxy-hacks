#!/usr/bin/env bash

if ! type -P sqlite3 >/dev/null 2>&1; then
    echo "sqlite3 missing; yum install -y /usr/bin/sqlite3"
    exit 1
fi

set -u
set -o pipefail

results_file=${1:?}

t=$(mktemp)
awk '{ print $1, $3, $5, $7, $9, $11, $13, $15 }' $results_file > $t

sqlite3 <<EOF
CREATE TABLE results (id INTEGER PRIMARY KEY,
	time_namelookup REAL,
	time_connect REAL,
	time_pretransfer REAL,
	time_starttransfer REAL,
	http_code INTEGER,
	port INTEGER,
        time_total REAL);
.separator " "
.import $t results
.headers on
.mode column
SELECT MIN(time_total) AS MIN_TIME_TOTAL,
       MAX(time_total) AS MAX_TIME_TOTAL,
       ROUND(avg(time_total),3) AS AVG_TIME_TOTAL,
       MAX(time_namelookup) AS MAX_NAMELOOKUP,
       MAX(time_connect) AS MAX_CONNECT,
       MAX(time_pretransfer) AS MAX_PRE_TRANSFER,
       MAX(time_starttransfer) AS MAX_START_TRANSFER
FROM results;

SELECT *
FROM results
WHERE time_total >= ${2:-0.100};
EOF

rm -f $t
